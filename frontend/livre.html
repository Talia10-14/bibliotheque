<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="livre.css">
    <link rel="stylesheet" href="tbadmin.css">
    <title>Nos livres disponible</title>
</head>

<body>
    <div class="page-wrapper">
        <header>
            <div class="logo">
                <i class="fas fa-book-open"></i>
                <span>Bibliotech</span>
            </div>
            <span class="tablo-biblio">Livres</span>
        </header>
        <div class="dashboard-layout">
            <aside class="sidebar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link " aria-current="page" href="accueil.html">Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tbadmin.html">Tableau de bord</a>
                      </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tbbiblio.html">Statistiques</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tbbiblio.html">Gestion des utilisateurs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tbbiblio.html">Actions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="livre.html">Livre</a>
                    </li>
                     <li class="nav-item">
                     <button onclick="ouvrirModal('modal-ajouter-livre')" >ajouter un nouveau livre</button>
                </li>
                </ul>
            </aside>
            <main>

        <div class="search-box">
                <input id="search-input" type="text" placeholder="Rechercher un livre, un auteur ou un sujet...">
                <button id="search-button" type="button"><i class="fas fa-search"></i></button>
            </div>
                <div class="d3">
                    <div class="div1">
                    </div>  
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>
                                    <p><strong>Face et Titre</strong></p>
                                </th>
                                <th>
                                    <p><strong> Auteur</strong></p>
                                </th>
                                <th>
                                    <p><strong>Description</strong></p>
                                </th>
                                <th>
                                    <p><strong>Date d'ajout</strong></p>
                                </th>
                                <th>
                                    <p><strong>Actions</strong></p>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                        <tfoot>
                        </tfoot>

                    </table>
                </div>
<div id="modal-ajouter-livre" class="modal hidden ">
    <div class="modal-content">
      <h3>Ajouter un Livre</h3>
      <form id="form-ajouter-livre">
        <input type="text" name="titre" placeholder="Titre du livre" required>
        <input type="text" name="auteur" placeholder="Auteur" required>
        <textarea name="description" id="description" placeholder="Description"></textarea>
        <label for="categorie">Catégorie :</label>
        <select id="categorie" name="categorie" required>
          <option value="">-- Sélectionnez une catégorie --</option>
          <option value="roman">Roman</option>
          <option value="science">Science</option>
          <option value="histoire">Histoire</option>
          <option value="biographie">Biographie</option>
          <option value="informatique">Informatique</option>
        </select>
      
        <input type="file" name="fichier" id="fichier" required>
        <input type="text" name="isbn" placeholder="ISBN (optionnel)">
        <input type="text" name="edition"  placeholder="Édition (optionnel)">
        <div>
            <input type="checkbox" name="disponible" id="disponible" checked>
            <label for="disponible">Disponible</label>
        </div>
        <button type="submit">Ajouter</button>
        <button type="button" onclick="fermerModal('modal-ajouter-livre')">Annuler</button>
      </form>
    </div>
  </div>
  <div id="modal-modifier-livre" class="modal hidden">
    <div class="modal-content">
      <h3>Modifier un Livre</h3>
      <form id="form-modifier-livre">
        <input type="text" id="mod-titre" name="titre" placeholder="Titre du livre" required>
        <input type="text" id="mod-auteur" name="auteur" placeholder="Auteur" required>
        <textarea id="mod-description" name="description" placeholder="Description"></textarea>
        <label for="mod-categorie">Catégorie :</label>
        <select id="mod-categorie" name="categorie" required>
          <option value="">-- Sélectionnez une catégorie --</option>
          <option value="roman">Roman</option>
          <option value="science">Science</option>
          <option value="histoire">Histoire</option>
          <option value="biographie">Biographie</option>
          <option value="informatique">Informatique</option>
        </select>
        <label for="fichier">Fichier du livre :</label>
        <input type="file" name="fichier" id="fichier"  required>
        <input type="text" id="mod-isbn" name="isbn" placeholder="ISBN (optionnel)">
        <input type="text" id="mod-edition" name="edition" placeholder="Édition (optionnel)">
        <div>
          <input type="checkbox" id="mod-disponible" name="disponible">
          <label for="mod-disponible">Disponible</label>
        </div>
        <button type="submit">Enregistrer</button>
        <button type="button" onclick="fermerModal('modal-modifier-livre')">Annuler</button>
      </form>
    </div>
  </div>
  
            </main>
        </div>
        <footer class="footer">
          <div class="footer-logo">
              <i class="fas fa-book-open"></i>
              <span>Bibliotech</span>
          </div>
          <p>© 2025 BiblioTech. Tous droits réservés.</p>
          <p><a href="#conditions">Conditions d'utilisation</a> | <a href="#confidentialite">Politique de
                  confidentialité</a></p>
      </footer>
      
    </div>
    <script src="lives-utiles.js"></script>
    <script>
      let tousLesLivres = [];

          function ouvrirModal(id) {
   const element= document.getElementById(id)
    console.log(element);
    element.style.display="block"
    
}

function fermerModal(id) {
    const element= document.getElementById(id)
    console.log(element);
    element.style.display="none"
}
const form = document.getElementById('form-ajouter-livre');

form.addEventListener('submit', async e => {
  e.preventDefault();
  const formData = new FormData(form);

  try {
    const token = localStorage.getItem('token');
    console.log("Token envoyé :", token);

    const res = await fetch('http://localhost:5000/api/livres', { 
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      }, // ne mets pas Content-Type ici, le navigateur gère multipart/form-data automatiquement
      body: formData
    });
    if (!res.ok) throw new Error('Erreur lors de l\'ajout');
    alert('Livre ajouté avec succès !');
    form.reset();
    fermerModal('modal-ajouter-livre'); 
    afficherTousLesLivres();
  } catch (err) {
    alert(err.message);
  }
});

document.addEventListener('DOMContentLoaded', async () => {
    await afficherTousLesLivres();

  const id = new URLSearchParams(window.location.search).get('id');
  if (!id) return;

  const res = await fetch(`http://localhost:5000/api/livres/${id}`);
  const livre = await res.json();

  const container = document.getElementById('details-livre');
  const carte = creerCarteLivre(livre);
  container.appendChild(carte);
});
async function afficherTousLesLivres() {
  try {
    const res = await fetch('http://localhost:5000/api/livres');
    tousLesLivres = await res.json();
afficherLivresFiltrés(tousLesLivres);

    // Partie cartes (grille)
    const container = document.querySelector('.div1'); // Grille des cartes
    container.innerHTML = ''; // Nettoyer avant ajout

    // Partie tableau
    const tableBody = document.getElementById('table-body'); // Corps du tableau
    tableBody.innerHTML = ''; // Nettoyer avant ajout

    tousLesLivres.forEach(livre => {
      // --- Carte ---
      const div = document.createElement('div');
      div.className = 'd2';

      div.innerHTML = 
      `
      <img src="http://localhost:5000/uploads/${livre.fichier}" alt="Face du livre" />
        <h3>${livre.titre}</h3>
        <p><strong>Auteur :</strong> ${livre.auteur}</p>
        <p><strong>Catégorie :</strong> ${livre.categorie}</p>
        <p><strong>Description :</strong> ${livre.description || 'Aucune'}</p>
        <p><strong>ISBN :</strong> ${livre.isbn || 'Non renseigné'}</p>
        <p><strong>Édition :</strong> ${livre.edition || 'Non renseignée'}</p>
        <p><strong>Disponible :</strong> ${livre.disponible ? 'Oui' : 'Non'}</p>
        <button class="btn-modifier" data-id="${livre._id}">Modifier</button>
        <button class="btn-supprimer" data-id="${livre._id}">Supprimer</button>
      `;
      container.appendChild(div);

    div.querySelector('.btn-modifier').addEventListener('click', () => ouvrirFormulaireModification(livre));
    div.querySelector('.btn-supprimer').addEventListener('click', () => supprimerLivre(livre._id));

      // --- Ligne tableau ---
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>
           <img src="http://localhost:5000/uploads/${livre.fichier}" alt="Face du livre" />
          <p>${livre.titre}</p>
        </td>
        <td>
          ${livre.auteur}
        </td>
         <td>
           ${livre.description || 'Aucune description'}
        </td>
        <td>
          ${new Date(livre.createdAt || Date.now()).toLocaleDateString()}
        </td>
        <td>
          <button class="btn-modifier" data-id="${livre._id}">Modifier</button>
          <button class="btn-supprimer" data-id="${livre._id}">Supprimer</button>
        </td>
      `;
      tableBody.appendChild(tr);
      tr.querySelector('.btn-modifier').addEventListener('click', () => ouvrirFormulaireModification(livre));
      tr.querySelector('.btn-supprimer').addEventListener('click', () => supprimerLivre(livre._id));
    });

  } catch (err) {
    console.error('Erreur lors de la récupération des livres :', err);
  }
}
function afficherLivresFiltrés(livres) {
  const container = document.querySelector('.div1'); 
  const tableBody = document.getElementById('table-body');
  container.innerHTML = '';
  tableBody.innerHTML = '';

  livres.forEach(livre => {
    // --- Carte ---
    const div = document.createElement('div');
    div.className = 'd2';
    div.innerHTML = `
      <img src="http://localhost:5000/uploads/${livre.fichier}" alt="Face du livre" />
      <h3>${livre.titre}</h3>
      <p><strong>Auteur :</strong> ${livre.auteur}</p>
      <p><strong>Catégorie :</strong> ${livre.categorie}</p>
      <p><strong>Description :</strong> ${livre.description || 'Aucune'}</p>
      <p><strong>ISBN :</strong> ${livre.isbn || 'Non renseigné'}</p>
      <p><strong>Édition :</strong> ${livre.edition || 'Non renseignée'}</p>
      <p><strong>Disponible :</strong> ${livre.disponible ? 'Oui' : 'Non'}</p>
      <button class="btn-modifier" data-id="${livre._id}">Modifier</button>
      <button class="btn-supprimer" data-id="${livre._id}">Supprimer</button>
    `;
    container.appendChild(div);
    div.querySelector('.btn-modifier').addEventListener('click', () => ouvrirFormulaireModification(livre));
    div.querySelector('.btn-supprimer').addEventListener('click', () => supprimerLivre(livre._id));

    // --- Ligne tableau ---
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
      <img src="http://localhost:5000/uploads/${livre.fichier}" alt="Face du livre" />
        <p>${livre.titre}</p>
      </td>
      <td>${livre.auteur}</td>
      <td>${livre.description || 'Aucune description'}</td>
      <td>${new Date(livre.createdAt || Date.now()).toLocaleDateString()}</td>
      <td>
        <button class="btn-modifier" data-id="${livre._id}">Modifier</button>
        <button class="btn-supprimer" data-id="${livre._id}">Supprimer</button>
      </td>
    `;
    tableBody.appendChild(tr);
    tr.querySelector('.btn-modifier').addEventListener('click', () => ouvrirFormulaireModification(livre));
    tr.querySelector('.btn-supprimer').addEventListener('click', () => supprimerLivre(livre._id));
  });
}
function filtrerLivres() {
  const motCle = document.getElementById('search-input').value.toLowerCase();

  const livresFiltres = tousLesLivres.filter(livre =>
    livre.titre.toLowerCase().includes(motCle) ||
    livre.auteur.toLowerCase().includes(motCle) ||
    (livre.description && livre.description.toLowerCase().includes(motCle))
  );

  afficherLivresFiltrés(livresFiltres);
}
document.getElementById('search-input').addEventListener('input', filtrerLivres);

let idLivreEnModification = null;

function ouvrirFormulaireModification(livre) {
  idLivreEnModification = livre._id;

  document.getElementById('mod-titre').value = livre.titre || '';
  document.getElementById('mod-auteur').value = livre.auteur || '';
  document.getElementById('mod-description').value = livre.description || '';
  document.getElementById('mod-categorie').value = livre.categorie || '';
  document.getElementById('mod-isbn').value = livre.isbn || '';
  document.getElementById('mod-edition').value = livre.edition || '';
  document.getElementById('mod-disponible').checked = livre.disponible || false;

  ouvrirModal('modal-modifier-livre');
}

const formModifier = document.getElementById('form-modifier-livre');

formModifier.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!idLivreEnModification) return alert("ID du livre manquant");

  const token = localStorage.getItem('token');

  const livreModifie = {
    titre: document.getElementById('mod-titre').value,
    auteur: document.getElementById('mod-auteur').value,
    description: document.getElementById('mod-description').value,
    categorie: document.getElementById('mod-categorie').value,
    isbn: document.getElementById('mod-isbn').value,
    edition: document.getElementById('mod-edition').value,
    disponible: document.getElementById('mod-disponible').checked
  };

  try {
    const res = await fetch(`http://localhost:5000/api/livres/${idLivreEnModification}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify(livreModifie)
    });

    if (res.ok) {
      alert('Livre modifié avec succès');
      fermerModal('modal-modifier-livre');
      afficherTousLesLivres(); // rafraîchir la liste affichée
    } else {
      const err = await res.json();
      alert('Erreur lors de la modification: ' + (err.message || 'Erreur inconnue'));
    }
  } catch (error) {
    console.error(error);
    alert('Erreur réseau lors de la modification');
  }
});


async function supprimerLivre(idLivre) {
    const token = localStorage.getItem('token'); 
  if (!confirm("Es-tu sûr de vouloir supprimer ce livre ?")) return;

  try {
    const res = await fetch(`http://localhost:5000/api/livres/${idLivre}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token // ajoute ici ton token si authentification
      }
    });

    if (res.ok) {
      alert('Livre supprimé avec succès');
      afficherTousLesLivres(); // rafraîchir la liste
    } else {
      const errorData = await res.json();
      alert('Erreur : ' + (errorData.message || 'Impossible de supprimer'));
    }
  } catch (err) {
    console.error(err);
    alert('Erreur réseau');
  }
}

    </script>
</body>

</html>